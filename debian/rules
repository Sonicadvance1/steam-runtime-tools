#!/usr/bin/make -f
# Copyright Â© 2019 Collabora Ltd.
# SPDX-License-Identifier: MIT
# (see debian/copyright)

export LC_ALL=C.UTF-8

include /usr/share/dpkg/default.mk

ifeq ($(shell dpkg --compare-versions `c++ -dumpversion || echo 0` ge 4.8 || echo old),old)
export CXX = g++-4.8
endif

meson_options =

ifeq ($(DEB_DISTRIBUTION),UNRELEASED)
meson_options += --werror
endif

%:
	dh $@

# We open-code the Meson clean, configure, build, test, install steps
# because the debhelper in SteamRT 1 'scout' is too old to have built-in
# knowledge of Meson.

override_dh_auto_clean:
	rm -fr _build
	rm -fr debian/locales

override_dh_auto_configure:
	if ! meson _build \
		--prefix=/usr/lib/pressure-vessel/relocatable \
		-Dman=true \
		-Dsrcdir=src \
		-Dversion=$(DEB_VERSION) \
		$(meson_options) \
	; then \
		cat _build/meson-logs/meson-log.txt; \
		exit 1; \
	fi

override_dh_auto_build:
	ninja -v -C _build

override_dh_auto_test:
ifeq ($(filter nocheck,$(DEB_BUILD_OPTIONS)),)
	mkdir debian/locales
	localedef -f UTF-8 -i en_US --no-archive debian/locales/en_US.UTF-8
	env LOCPATH=$(CURDIR)/debian/locales \
	meson test -C _build --verbose
endif

override_dh_auto_install:
	DESTDIR=$(CURDIR)/debian/tmp ninja -C _build install

override_dh_missing:
	dh_missing --fail-missing
